function initSkill(e){for(var o={},l=0;l<e.size();l++)o[e[l].n]=0;return o}function enable(e){var o=!0;return vm.selected.forEach(function(l){e.n==l.n&&(o=!1)}),""!=vm.condition&&e.n.indexOf(vm.condition)<0&&(o=!1),o}avalon.config({baseUrl:"lib",debug:!1});var armor=[[[],[],[],[],[]],[[],[],[],[],[]]],gem=[],skillEffect={},skill=[],stone={},holeValue=[0,14,32,61],vm=avalon.define({$id:"mho",popup:"",closable:!0,skill:[],selected:[],armor:[],gem:[],stone:[],own:[],info:"",condition:"",$computed:{ranged:{set:function(e){localStorage.setItem("ranged",e)},get:function(){return localStorage.getItem("ranged")?eval(localStorage.getItem("ranged")):!1}}},hidePopup:function(e){vm.closable&&"div"==e.target.nodeName.toLowerCase()&&(vm.popup="")},listSkill:function(){vm.skill=skill.filter(enable),vm.closable=!0,vm.popup="skill_choose"},addSkill:function(e,o){vm.selected.push({n:e.n,v:e.v,r:10,hv:[0,0,0,0],s:e.s}),vm.condition="",vm.popup=""},skillMinus:function(e){e.r--},skillPlus:function(e){e.r++},skillJoin:function(e){var o=[];for(var l in e)o.push(l+e[l]);return o.join("，")},showChosen:function(e){e.o=!e.o},secondary:!1,showSecondary:function(){vm.secondary=!vm.secondary},calc:function(){var e=initSkill(vm.selected),o=vm.ranged?1:0,l={};vm.gem=[],vm.stone=[],holeValue=[0,0,0,0];for(var r=0;r<vm.selected.size();r++)vm.selected[r].hv=[0,0,0,0];for(var n=1;3>=n;n++)for(var s in gem)if(gem[s].h==n){for(var m=-1,r=0;r<vm.selected.size();r++){var t=vm.selected[r].n;t in gem[s].s&&gem[s].s[t]>0&&(m=r)}if(m>-1)for(var r=0;r<vm.selected.size();r++){var t=vm.selected[r].n;t in gem[s].s&&(vm.selected[m].hv[n]+=gem[s].s[t]*vm.selected[r].v)}}for(var n=1;3>=n;n++){for(var r=0;r<vm.selected.size();r++){var t=vm.selected[r].n;0==vm.selected[r].hv[n]&&(vm.selected[r].hv[n]=1==n?10:vm.selected[r].hv[1]+vm.selected[r].hv[n-1]),holeValue[n]+=vm.selected[r].hv[n]}holeValue[n]=holeValue[n]/vm.selected.size()}do{l=initSkill(vm.selected),vm.armor=[];for(var s=0;5>s;s++){var a=0,v=-1;for(var i in armor[o][s]){for(var c=holeValue[armor[o][s][i].h],r=0;r<vm.selected.size();r++){var t=vm.selected[r].n;t in armor[o][s][i].s&&(c+=vm.selected[r].v*armor[o][s][i].s[t]*vm.selected[r].r/(vm.selected[r].r+1.5*e[t]))}c>a&&(a=c,v=i)}a>0&&vm.armor.push(armor[o][s][v])}for(var f=0,d=0,r=0;r<vm.selected.size();r++){for(var t=vm.selected[r].n,s=0;s<vm.armor.size();s++)t in vm.armor[s].s&&(l[t]+=vm.armor[s].s[t]);l[t]>vm.selected[r].r+e[t]?(e[t]++,f++):l[t]<vm.selected[r].r&&d++}}while(f>0&&d>0);var u=0;l=initSkill(vm.selected),vm.own=[];for(var s=0;s<vm.armor.size();s++){vm.armor[s].h>u&&(u=vm.armor[s].h);for(var r in vm.armor[s].s)r in l?l[r]+=vm.armor[s].s[r]:l[r]=vm.armor[s].s[r]}Object.keys(l).forEach(function(e){vm.own.push({n:e,v:l[e]})}),vm.own.sort(function(e,o){var l=vm.selected.size(),r=l;return vm.selected.forEach(function(n,s){e.n==n.n&&(l=s),o.n==n.n&&(r=s)}),l-r});for(var r=0;r<vm.selected.size();r++){var t=vm.selected[r].n;vm.selected[r].s&&vm.selected[r].r>l[t]&&vm.stone.push(vm.selected[r].s);for(var s in gem)t in gem[s].s&&gem[s].s[t]>0&&gem[s].s[t]<=vm.selected[r].r-l[t]&&vm.gem.push(gem[s])}},reload:function(){vm.popup="before_loading",vm.closable=!0},load:function(){}});vm.$watch("condition",function(e,o){vm.skill=skill.filter(enable)}),vm.$watch("popup",function(e,o){""!=e&&(document.documentElement.scrollTop=0,document.body.scrollTop=0)}),require(["domReady!","mmRequest"],function(){var e=localStorage.getItem("update");if(e)if(new Date(e).getTime()>1454463500588){vm.popup="loading",vm.closable=!1,vm.info="读取本地缓存…";var o=new Promise(function(e,o){armor=JSON.parse(localStorage.getItem("armor")),skill=JSON.parse(localStorage.getItem("skill")),gem=JSON.parse(localStorage.getItem("gem")),e("读取本地缓存…")});o.then(function(){vm.popup=""})}else vm.popup="loading",vm.info="已更新算法和数据，旧数据虽仍可用，建议点击“重新读取数据”更新数据…",vm.closable=!0;else vm.popup="before_loading",vm.closable=!1;vm.load=function(){vm.popup="loading",vm.closable=!1,vm.info="数据读取中…",avalon.get("all.json").done(function(e){if(0==e.errCode&&"success"==e.msg){armor=[[[],[],[],[],[]],[[],[],[],[],[]]],skill=[],gem=[],vm.selected=[];var o=e.result;for(var l in o){var r=o[l],n=r.iID,s=r.data;if(n>=6e4&&7e4>n&&s[12]>=40){for(var m=s[3],t=n%5,a=[],v=21;37>v;v+=3)""!=s[v]&&a.push(s[v]+"x"+s[v+1]);for(var i={},v=38;47>v;v+=2)"#N/A"!=s[v]&&(i[s[v]]=parseInt(s[v+1],10));r={n:s[1],h:s[5],m:a.join("，"),s:i,o:!1},armor[m][t].push(r)}else if(n>=1e6&&2e6>n)"无"!=s[3]&&(skillEffect[s[3]]=10);else if(n>=2e6&&3e6>n)stone[s[2]]=s.slice(2),skillEffect[s[2]]=0==s[7]?7:parseInt(100/s[7],10);else if(n>=5e6&&6e6>n){var a=[s[13]+"x"+s[14],s[15]+"x"+s[16]];""!=s[17]&&a.push(s[17]+"x"+s[18]);var i={};i[s[5]]=parseInt(s[6],10),""!=s[8]&&(i[s[8]]=parseInt(s[9],10)),r={n:s[2],h:s[3],m:a.join("，"),s:i,o:!1},gem.push(r)}}Object.keys(skillEffect).forEach(function(e){skill.push({n:e,v:skillEffect[e],s:stone[e]})}),localStorage.setItem("armor",JSON.stringify(armor)),localStorage.setItem("skill",JSON.stringify(skill)),localStorage.setItem("gem",JSON.stringify(gem)),localStorage.setItem("update",new Date),vm.popup=""}else vm.info="数据读取失败…请稍后再试"}).fail(function(){vm.info="数据读取失败…请稍后再试"})}});
function initSkill(val){for(var result={},s=0;s<vm.selected.size();s++)result[vm.selected[s].n]=val?eval(val):vm.selected[s].r;return result}function enable(e){var r=!0;return vm.selected.forEach(function(o){e.n==o.n&&(r=!1)}),""!=vm.condition&&e.n.indexOf(vm.condition)<0&&(r=!1),r}function holeMap(e){return function(r,o){return o==e?r+1:r}}function shortMap(e,r){for(var o={},n=0;n<vm.selected.size();n++){var t=vm.selected[n].n;o[t]=t in e?r[t]-e[t]:r[t]}return o}function hasMap(e,r){for(var o={},n=0;n<e.length;n++)for(var t in e[n])t in o?o[t]+=e[n][t]*r[n]:"$"!=t[0]&&(o[t]=e[n][t]*r[n]);return o}function shortVal(e){for(var r=0,o=0;o<vm.selected.size();o++){var n=vm.selected[o].n,t=vm.selected[o].s?Math.max(vm.selected[o].s[4],vm.selected[o].s[5]):0;r+=e[n]<=0?0:1e3+e[n]*vm.selected[o].v+(e[n]>t?1e4:0)}return r}avalon.config({baseUrl:"lib",debug:!1});var armor=[[[],[],[],[],[]],[[],[],[],[],[]]],gem=[],skillEffect={},skill=[],stone={},resultMessage=["无需护石即可配出","至少需要单属性护石可配出","至少需要双属性护石可配出"],vm=avalon.define({$id:"mho",last:0,popup:"",closable:!0,skill:[],selected:[],armor:[],gem:[],stone:[],own:[],info:"",condition:"",hasStone:!1,result:"",$computed:{ranged:{set:function(e){localStorage.setItem("ranged",e)},get:function(){return localStorage.getItem("ranged")?eval(localStorage.getItem("ranged")):!1}}},hidePopup:function(e){vm.closable&&"div"==e.target.nodeName.toLowerCase()&&(vm.popup="")},listSkill:function(){vm.skill=skill.filter(enable),vm.closable=!0,vm.popup="skill_choose"},addSkill:function(e,r){vm.selected.push({n:e.n,v:e.v,r:10,s:e.s}),vm.condition="",vm.popup=""},skillMinus:function(e){e.r--,vm.result=""},skillPlus:function(e){e.r++,vm.result=""},skillJoin:function(e){var r=[];for(var o in e)r.push(o+e[o]);return r.join("，")},showChosen:function(e){e.o=!e.o},secondary:!1,showSecondary:function(){vm.secondary=!vm.secondary},calc:function(){vm.popup="loading",vm.closable=!1,vm.info="计算中，请稍候…",setTimeout(function(){var e=vm.ranged?1:0;vm.stone=[],vm.armor=[],vm.gem=[],vm.own=[];for(var r=[[],[],[],[],[]],o=[{},{},{},{},{}],n=vm.selected.size(),t=new Array(n),a=initSkill("[]"),l=[0,0,0,0],s=[0,0,0,0],i=0;n>i;i++){var v=vm.selected[i].n,m=new Array(4);for(var c in gem)v in gem[c].s&&gem[c].s[v]>0&&(a[v].push(gem[c]),m[gem[c].h]=gem[c].s);var f=0;t[i]=new Array(f=m[3]?6:1);for(var u=f-1?5:0;u>=0;u--){t[i][u]=new Array(f=m[2]?6-u:1);for(var p=f-1;p>=0;p--){t[i][u][p]=new Array(f=m[1]?16-3*u-2*p:1);for(var h=f-1;h>=0;h--)t[i][u][p][h]=hasMap(m,[0,h,p,u])}}t[i][0][0][1]&&(l[1]+=t[i][0][0][1][v]*vm.selected[i].v,s[1]++),t[i][0][1]&&(l[2]+=t[i][0][1][0][v]*vm.selected[i].v,s[2]++),t[i][1]&&(l[3]+=t[i][1][0][0][v]*vm.selected[i].v,s[3]++)}0!=s[1]&&(l[1]=l[1]/s[1]),l[2]=0==s[2]?2*l[1]:l[2]/s[2],l[3]=0==s[3]?l[2]+l[1]:l[3]/s[3];for(var d=[[],[],[],[],[]],c=0;5>c;c++){var g=!0;for(var k in armor[e][c]){for(var S=armor[e][c][k].h,w=0,i=0;n>i;i++){var v=vm.selected[i].n;v in armor[e][c][k].s&&(w+=vm.selected[i].v*armor[e][c][k].s[v])}(w>0||g&&3==S)&&(armor[e][c][k].val=w+l[armor[e][c][k].h],d[c].push(armor[e][c][k]),g=g&&3!=S)}d[c].sort(function(e,r){return r.val-e.val}),d[c].splice(3,d[c].length-3),d[c].sort(function(e,r){return e.h-r.h})}for(var M=shortVal(initSkill()),b=[],y={},I=[],A=[Math.min(d[0].length,3),Math.min(d[1].length,3),Math.min(d[2].length,3),Math.min(d[3].length,3),Math.min(d[4].length,3)],E=0;E<A[0];E++){o[0]=shortMap(d[0][E].s,initSkill()),r[0]=[0,0,0,0].map(holeMap(d[0][E].h));for(var O=0;O<A[1];O++){o[1]=shortMap(d[1][O].s,o[0]),r[1]=r[0].map(holeMap(d[1][O].h));for(var z=0;z<A[2];z++){o[2]=shortMap(d[2][z].s,o[1]),r[2]=r[1].map(holeMap(d[2][z].h));for(var N=0;N<A[3];N++){o[3]=shortMap(d[3][N].s,o[2]),r[3]=r[2].map(holeMap(d[3][N].h));for(var $=0;$<A[4];$++){o[4]=shortMap(d[4][$].s,o[3]),r[4]=r[3].map(holeMap(d[4][$].h));for(var J=initSkill("[]"),_=shortVal(o[4]),f=0,j=new Array(f=r[4][3]+1),q=new Array(f),i=0;n>i;i++)for(var v=vm.selected[i].n,u=(a[v].length,r[4][3]);u>=0;u--){f=r[4][2]+r[4][3]-u+1,j[u]||(j[u]=new Array(f),q[u]=new Array(f));for(var p=f-1;p>=0;p--){f=r[4][1]+3*(r[4][3]-u)+2*(r[4][2]-p)+1,j[u][p]||(j[u][p]=new Array(f),q[u][p]=new Array(f));for(var h=f-1;h>=0;h--){for(var x=0==i?_:j[u][p][h],T=0==i?o[4]:q[u][p][h],V=u;V>=0;V--)for(var D=p;D>=0;D--)for(var P=h;P>=0;P--)if(t[i][V]&&t[i][V][D]&&t[i][V][D][P]){var C=shortMap(t[i][V][D][P],0==i?o[4]:q[u-V][p-D][h-P]),R=shortVal(C);x>R&&(x=R,T=C,J[v].push({hole:[0,h,p,u],use:[0,P,D,V]}),M>R&&(M=R,b=[E,O,z,N,$],I=[i,h,p,u],y=J))}j[u][p][h]=x,q[u][p][h]=T}}}}}}}}for(var L=initSkill("0"),c=0;5>c;c++){var U=d[c][b[c]];for(var i in U.s)i in L?L[i]+=U.s[i]:"$"!=i[0]&&(L[i]=U.s[i]);vm.armor.push(U)}do{for(var v=vm.selected[I[0]].n,B=y[v],F=null,c=0,S=B[0];c<B.length;S=B[++c])S.hole[1]==I[1]&&S.hole[2]==I[2]&&S.hole[3]==I[3]&&(F=S);if(F){var G=F.use;I=[I[0]-1,I[1]-G[1],I[2]-G[2],I[3]-G[3]];for(var c=0;c<a[v].length;c++){var H=a[v][c];H.use=G[H.h];for(var i in H.s)i in L?L[i]+=H.s[i]*H.use:"$"!=i[0]&&(L[i]=H.s[i]*H.use);H.use>0&&vm.gem.push(H)}}else I=[I[0]-1,I[1],I[2],I[3]]}while(I[0]>=0&&(0!=I[1]||0!=I[2]||0!=I[3]));Object.keys(L).forEach(function(e){vm.own.push({n:e,v:L[e]})}),vm.own.sort(function(e,r){var o=vm.selected.size(),n=o;return vm.selected.forEach(function(t,a){e.n==t.n&&(o=a),r.n==t.n&&(n=a)}),o-n});for(var K=0,i=0;i<vm.selected.size();i++){var v=vm.selected[i].n;vm.selected[i].r>L[v]&&(K++,vm.selected[i].s&&vm.stone.push(vm.selected[i].s))}K>(vm.hasStone?0:Math.min(2,vm.stone.size()))?vm.result="无法配出":vm.result=vm.hasStone?"使用已有护石可以配出":resultMessage[vm.stone.size()],vm.popup=""},100)},reload:function(){vm.popup="before_loading",vm.closable=!0},load:function(){}});vm.$watch("condition",function(e,r){vm.skill=skill.filter(enable)}),vm.$watch("popup",function(e,r){""!=e&&(document.documentElement.scrollTop=0,document.body.scrollTop=0)}),vm.$watch("selected.length",function(e,r){vm.result=""}),require(["domReady!","mmRequest"],function(){if(vm.last=localStorage.getItem("update"),vm.last)if(vm.last=new Date(vm.last),vm.last.getTime()>1456200635506){vm.popup="loading",vm.closable=!1,vm.info="读取本地缓存…";var e=new Promise(function(e,r){armor=JSON.parse(localStorage.getItem("armor")),skill=JSON.parse(localStorage.getItem("skill")),gem=JSON.parse(localStorage.getItem("gem")),e("读取本地缓存…")});e.then(function(){vm.popup=""})}else vm.popup="before_loading",vm.closable=!1;else vm.popup="before_loading",vm.closable=!1;vm.load=function(){vm.popup="loading",vm.closable=!1,vm.info="数据读取中…",avalon.getScript("http://c.gamer.qq.com/mho/rsync_cdn_filename_all.js").done(function(){armor=[[[],[],[],[],[]],[[],[],[],[],[]]],skill=[],gem=[],vm.selected=[];for(var e in equipcb){var r=equipcb[e],o=r.iID,n=r.data;if(o>=6e4&&7e4>o&&n[12]>=40){for(var t=n[3],a=o%5,l=[],s=21;37>s;s+=3)""!=n[s]&&l.push(n[s]+"x"+n[s+1]);for(var i={},s=38;47>s;s+=2)"#N/A"!=n[s]&&(i[n[s]]=parseInt(n[s+1],10));r={n:n[1],h:n[5],m:l.join("，"),s:i,o:!1},armor[t][a].push(r)}else if(o>=1e6&&2e6>o)skillEffect[n[3]]=95;else if(o>=2e6&&3e6>o)stone[n[2]]=n.slice(2),skillEffect[n[2]]=0!=n[7]?parseInt(100/n[7],10):parseInt(100/n[6],10);else if(o>=5e6&&6e6>o){var l=[n[13]+"x"+n[14],n[15]+"x"+n[16]];""!=n[17]&&l.push(n[17]+"x"+n[18]);var i={};i[n[5]]=parseInt(n[6],10),""!=n[8]&&(i[n[8]]=parseInt(n[9],10)),r={n:n[2],h:n[3],m:l.join("，"),s:i,o:!1},gem.push(r)}}Object.keys(skillEffect).forEach(function(e){skill.push({n:e,v:skillEffect[e],s:stone[e]})}),localStorage.setItem("armor",JSON.stringify(armor)),localStorage.setItem("skill",JSON.stringify(skill)),localStorage.setItem("gem",JSON.stringify(gem)),vm.last=new Date,localStorage.setItem("update",vm.last),vm.popup=""}).fail(function(){vm.info="数据读取失败…请稍后再试"})}});
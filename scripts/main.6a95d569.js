function initSkill(val){for(var result={},s=0;s<vm.selected.size();s++)result[vm.selected[s].n]=val?eval(val):vm.selected[s].r;return result}function enable(e){var r=!0;return vm.selected.forEach(function(o){e.n==o.n&&(r=!1)}),""!=vm.condition&&e.n.indexOf(vm.condition)<0&&(r=!1),r}function holeMap(e){return function(r,o){return o==e?r+1:r}}function shortMap(e,r){for(var o={},n=0;n<vm.selected.size();n++){var a=vm.selected[n].n;o[a]=a in e?r[a]-e[a]:r[a]}return o}function hasMap(e,r){for(var o={},n=0;n<e.length;n++)for(var a in e[n])a in o?o[a]+=e[n][a]*r[n]:"$"!=a[0]&&(o[a]=e[n][a]*r[n]);return o}function shortVal(e){for(var r=0,o=0;o<vm.selected.size();o++){var n=vm.selected[o].n,a=vm.selected[o].s?Math.max(vm.selected[o].s[4],vm.selected[o].s[5]):0;r+=e[n]<=0?0:1e3+e[n]*vm.selected[o].v+(e[n]>a?1e4:0)}return r}avalon.config({baseUrl:"lib",debug:!1});var armor=[[[],[],[],[],[]],[[],[],[],[],[]]],gem=[],skillEffect={},skill=[],stone={},estimate_hv=[0,14,32,61],resultMessage=["无需护石即可配出","至少需要单属性护石可配出","至少需要双属性护石可配出"],vm=avalon.define({$id:"mho",popup:"",closable:!0,skill:[],selected:[],armor:[],gem:[],stone:[],own:[],info:"",condition:"",hasStone:!1,result:"",$computed:{ranged:{set:function(e){localStorage.setItem("ranged",e)},get:function(){return localStorage.getItem("ranged")?eval(localStorage.getItem("ranged")):!1}}},hidePopup:function(e){vm.closable&&"div"==e.target.nodeName.toLowerCase()&&(vm.popup="")},listSkill:function(){vm.skill=skill.filter(enable),vm.closable=!0,vm.popup="skill_choose"},addSkill:function(e,r){vm.selected.push({n:e.n,v:e.v,r:10,s:e.s}),vm.condition="",vm.popup=""},skillMinus:function(e){e.r--,vm.result=""},skillPlus:function(e){e.r++,vm.result=""},skillJoin:function(e){var r=[];for(var o in e)r.push(o+e[o]);return r.join("，")},showChosen:function(e){e.o=!e.o},secondary:!1,showSecondary:function(){vm.secondary=!vm.secondary},calc:function(){vm.popup="loading",vm.closable=!1,vm.info="计算中，请稍候…",setTimeout(function(){var e=vm.ranged?1:0;vm.stone=[],vm.armor=[],vm.gem=[],vm.own=[];for(var r=[[],[],[],[],[]],o=[{},{},{},{},{}],n=vm.selected.size(),a=new Array(n),t=initSkill("[]"),l=0;n>l;l++){var s=vm.selected[l].n,i=(vm.selected[l].r+5,new Array(4));for(var v in gem)s in gem[v].s&&gem[v].s[s]>0&&(t[s].push(gem[v]),i[gem[v].h]=gem[v].s);var m=0;a[l]=new Array(m=i[3]?6:1);for(var c=m-1?5:0;c>=0;c--){a[l][c]=new Array(m=i[2]?6-c:1);for(var f=m-1;f>=0;f--){a[l][c][f]=new Array(m=i[1]?16-3*c-2*f:1);for(var u=m-1;u>=0;u--)a[l][c][f][u]=hasMap(i,[0,u,f,c])}}}for(var p=[[],[],[],[],[]],v=0;5>v;v++){var h=!0;for(var d in armor[e][v]){for(var g=armor[e][v][d].h,k=0,l=0;n>l;l++){var s=vm.selected[l].n;s in armor[e][v][d].s&&(k+=vm.selected[l].v*armor[e][v][d].s[s])}(k>0||h&&3==g)&&(armor[e][v][d].val=k+estimate_hv[armor[e][v][d].h],p[v].push(armor[e][v][d]))}p[v].sort(function(e,r){return r.val-e.val})}for(var S=shortVal(initSkill()),w=[],M={},y=[],b=[Math.min(p[0].length,3),Math.min(p[1].length,3),Math.min(p[2].length,3),Math.min(p[3].length,3),Math.min(p[4].length,3)],I=0;I<b[0];I++){o[0]=shortMap(p[0][I].s,initSkill()),r[0]=[0,0,0,0].map(holeMap(p[0][I].h));for(var A=0;A<b[1];A++){o[1]=shortMap(p[1][A].s,o[0]),r[1]=r[0].map(holeMap(p[1][A].h));for(var E=0;E<b[2];E++){o[2]=shortMap(p[2][E].s,o[1]),r[2]=r[1].map(holeMap(p[2][E].h));for(var O=0;O<b[3];O++){o[3]=shortMap(p[3][O].s,o[2]),r[3]=r[2].map(holeMap(p[3][O].h));for(var z=0;z<b[4];z++){o[4]=shortMap(p[4][z].s,o[3]),r[4]=r[3].map(holeMap(p[4][z].h));for(var N=initSkill("[]"),$=shortVal(o[4]),m=0,J=new Array(m=r[4][3]+1),j=new Array(m),l=0;n>l;l++)for(var s=vm.selected[l].n,c=(t[s].length,r[4][3]);c>=0;c--){m=r[4][2]+r[4][3]-c+1,J[c]||(J[c]=new Array(m),j[c]=new Array(m));for(var f=m-1;f>=0;f--){m=r[4][1]+3*(r[4][3]-c)+2*(r[4][2]-f)+1,J[c][f]||(J[c][f]=new Array(m),j[c][f]=new Array(m));for(var u=m-1;u>=0;u--){for(var x=0==l?$:J[c][f][u],_=0==l?o[4]:j[c][f][u],T=c;T>=0;T--)for(var V=f;V>=0;V--)for(var C=u;C>=0;C--)if(a[l][T]&&a[l][T][V]&&a[l][T][V][C]){var D=shortMap(a[l][T][V][C],0==l?o[4]:j[c-T][f-V][u-C]),P=shortVal(D);x>P&&(x=P,_=D,N[s].push({hole:[0,u,f,c],use:[0,C,V,T]}),S>P&&(S=P,w=[I,A,E,O,z],y=[l,u,f,c],M=N))}J[c][f][u]=x,j[c][f][u]=_}}}}}}}}for(var q=initSkill("0"),v=0;5>v;v++){var R=p[v][w[v]];for(var l in R.s)l in q?q[l]+=R.s[l]:"$"!=l[0]&&(q[l]=R.s[l]);vm.armor.push(R)}do{for(var s=vm.selected[y[0]].n,L=M[s],U=null,v=0,g=L[0];v<L.length;g=L[++v])g.hole[1]==y[1]&&g.hole[2]==y[2]&&g.hole[3]==y[3]&&(U=g);if(U){var B=U.use;y=[y[0]-1,y[1]-B[1],y[2]-B[2],y[3]-B[3]];for(var v=0;v<t[s].length;v++){var F=t[s][v];F.use=B[F.h];for(var l in F.s)l in q?q[l]+=F.s[l]*F.use:"$"!=l[0]&&(q[l]=F.s[l]*F.use);F.use>0&&vm.gem.push(F)}}else y=[y[0]-1,y[1],y[2],y[3]]}while(y[0]>=0&&(0!=y[1]||0!=y[2]||0!=y[3]));Object.keys(q).forEach(function(e){vm.own.push({n:e,v:q[e]})}),vm.own.sort(function(e,r){var o=vm.selected.size(),n=o;return vm.selected.forEach(function(a,t){e.n==a.n&&(o=t),r.n==a.n&&(n=t)}),o-n});for(var G=0,l=0;l<vm.selected.size();l++){var s=vm.selected[l].n;vm.selected[l].r>q[s]&&(G++,vm.selected[l].s&&vm.stone.push(vm.selected[l].s))}G>(vm.hasStone?0:Math.min(2,vm.stone.size()))?vm.result="无法配出":vm.result=vm.hasStone?"使用已有护石可以配出":resultMessage[vm.stone.size()],vm.popup=""},100)},reload:function(){vm.popup="before_loading",vm.closable=!0},load:function(){}});vm.$watch("condition",function(e,r){vm.skill=skill.filter(enable)}),vm.$watch("popup",function(e,r){""!=e&&(document.documentElement.scrollTop=0,document.body.scrollTop=0)}),vm.$watch("selected.length",function(e,r){vm.result=""}),require(["domReady!","mmRequest"],function(){var e=localStorage.getItem("update");if(e)if(new Date(e).getTime()>1456200635506){vm.popup="loading",vm.closable=!1,vm.info="读取本地缓存…";var r=new Promise(function(e,r){armor=JSON.parse(localStorage.getItem("armor")),skill=JSON.parse(localStorage.getItem("skill")),gem=JSON.parse(localStorage.getItem("gem")),e("读取本地缓存…")});r.then(function(){vm.popup=""})}else vm.popup="before_loading",vm.closable=!1;else vm.popup="before_loading",vm.closable=!1;vm.load=function(){vm.popup="loading",vm.closable=!1,vm.info="数据读取中…",avalon.get("all.json").done(function(e){if(0==e.errCode&&"success"==e.msg){armor=[[[],[],[],[],[]],[[],[],[],[],[]]],skill=[],gem=[],vm.selected=[];var r=e.result;for(var o in r){var n=r[o],a=n.iID,t=n.data;if(a>=6e4&&7e4>a&&t[12]>=40){for(var l=t[3],s=a%5,i=[],v=21;37>v;v+=3)""!=t[v]&&i.push(t[v]+"x"+t[v+1]);for(var m={},v=38;47>v;v+=2)"#N/A"!=t[v]&&(m[t[v]]=parseInt(t[v+1],10));n={n:t[1],h:t[5],m:i.join("，"),s:m,o:!1},armor[l][s].push(n)}else if(a>=1e6&&2e6>a)skillEffect[t[3]]=95;else if(a>=2e6&&3e6>a)stone[t[2]]=t.slice(2),skillEffect[t[2]]=0!=t[7]?parseInt(100/t[7],10):parseInt(100/t[6],10);else if(a>=5e6&&6e6>a){var i=[t[13]+"x"+t[14],t[15]+"x"+t[16]];""!=t[17]&&i.push(t[17]+"x"+t[18]);var m={};m[t[5]]=parseInt(t[6],10),""!=t[8]&&(m[t[8]]=parseInt(t[9],10)),n={n:t[2],h:t[3],m:i.join("，"),s:m,o:!1},gem.push(n)}}Object.keys(skillEffect).forEach(function(e){skill.push({n:e,v:skillEffect[e],s:stone[e]})}),localStorage.setItem("armor",JSON.stringify(armor)),localStorage.setItem("skill",JSON.stringify(skill)),localStorage.setItem("gem",JSON.stringify(gem)),localStorage.setItem("update",new Date),vm.popup=""}else vm.info="数据读取失败…请稍后再试"}).fail(function(){vm.info="数据读取失败…请稍后再试"})}});
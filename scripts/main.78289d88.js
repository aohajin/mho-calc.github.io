function initSkill(val){for(var result={},s=0;s<vm.selected.size();s++)result[vm.selected[s].n]=val?eval(val):vm.selected[s].r;return result}function enable(e){var r=!0;return vm.selected.forEach(function(o){e.n==o.n&&(r=!1)}),""!=vm.condition&&e.n.indexOf(vm.condition)<0&&(r=!1),r}function holeMap(e){return function(r,o){return o==e?r+1:r}}function shortMap(e,r){for(var o={},n=0;n<vm.selected.size();n++){var a=vm.selected[n].n;o[a]=a in e?r[a]-e[a]:r[a]}return o}function hasMap(e,r){for(var o={},n=0;n<e.length;n++)for(var a in e[n])a in o?o[a]+=e[n][a]*r[n]:"$"!=a[0]&&(o[a]=e[n][a]*r[n]);return o}function shortVal(e){for(var r=0,o=0;o<vm.selected.size();o++){var n=vm.selected[o].n,a=vm.selected[o].s?Math.max(vm.selected[o].s[4],vm.selected[o].s[5]):0;r+=e[n]<=0?0:1e3+e[n]*vm.selected[o].v+(e[n]>a?1e4:0)}return r}function holes(e,r,o,n){return e*!!(o-1)+r*o}function result_view(e){vm.view="result",""==vm.result&&(vm.stone=[]),vm.armor=[],vm.gem=[],vm.own=[];var r=e.ranged,o=e.skill.split("~");e.armor.split("~").forEach(function(e,o){vm.armor.push(armor[r][o][e])}),e.gem.split("~").forEach(function(e,r){var o=e.split("*"),n=gem[o[0]];n.use=o[1],vm.gem.push(n)}),e.own.split("~").forEach(function(e,r){var o=e.split("*");vm.own.push({n:o[0],v:o[1]})}),vm.own.sort(function(e,r){var n=100,a=100;return o.forEach(function(o,t){e.n==o&&(n=t),r.n==o&&(a=t)}),n-a})}avalon.config({baseUrl:"lib",debug:!1});var armor=[[[],[],[],[],[]],[[],[],[],[],[]]],gem=[],skillEffect={},skill=[],stone={},resultMessage=["无需护石即可配出","至少需要单属性护石可配出","至少需要双属性护石可配出"],vm=avalon.define({$id:"mho",view:"param",last:0,popup:"",closable:!0,skill:[],selected:[],armor:[],gem:[],stone:[],own:[],info:"",condition:"",hasStone:!1,result:"",armorText:[["头盔","铠甲","腕甲","腰甲","腿甲"],["战帽","护甲","护手","护腰","护腿"]],optionalArmor:[],selectedArmor:new Array(5),selectedArmorIndex:new Array(5),pos:-1,$computed:{ranged:{set:function(e){this.selectedArmor=new Array(5),localStorage.setItem("ranged",e)},get:function(){var flag=localStorage.getItem("ranged")?eval(localStorage.getItem("ranged")):!1;return flag}}},hidePopup:function(e){vm.closable&&"div"==e.target.nodeName.toLowerCase()&&(vm.popup="")},listSkill:function(){vm.skill=skill.filter(enable),vm.closable=!0,vm.popup="skill_choose"},addSkill:function(e){vm.selected.push({n:e.n,v:e.v,r:10,s:e.s}),vm.condition="",vm.popup=""},skillMinus:function(e){e.r--},skillPlus:function(e){e.r++},listArmor:function(e){vm.optionalArmor=armor[vm.ranged?1:0][vm.pos=e],vm.closable=!0,vm.popup="armor_choose"},addArmor:function(e){vm.selectedArmor.set(vm.pos,armor[vm.ranged?1:0][vm.pos][e]),vm.selectedArmorIndex[vm.pos]=e,vm.popup=""},removeArmor:function(e){vm.selectedArmor.set(e,void 0)},skillJoin:function(e){var r=[];for(var o in e)r.push(o+e[o]);return r.join("，")},showChosen:function(e){e.o=!e.o},secondary:!1,showSecondary:function(){vm.secondary=!vm.secondary},calc:function(){vm.popup="loading",vm.closable=!1,vm.info="计算中，请稍候…",setTimeout(function(){var e=vm.ranged?1:0;vm.stone=[];for(var r=[[],[],[],[],[]],o=[{},{},{},{},{}],n=vm.selected.size(),a=new Array(n),t=initSkill("[]"),l=[0,0,0,0],s=[0,0,0,0],m=0;n>m;m++){var i=vm.selected[m].n,v=new Array(4);for(var c in gem)i in gem[c].s&&gem[c].s[i]>0&&(t[i].push(gem[c]),v[gem[c].h]=gem[c].s);var u=0;a[m]=new Array(u=v[3]?6:1);for(var f=u-1?5:0;f>=0;f--){a[m][f]=new Array(u=v[2]?6-f:1);for(var p=u-1;p>=0;p--){a[m][f][p]=new Array(u=v[1]?16-3*f-2*p:1);for(var d=u-1;d>=0;d--)a[m][f][p][d]=hasMap(v,[0,d,p,f])}}a[m][0][0][1]&&(l[1]+=a[m][0][0][1][i]*vm.selected[m].v,s[1]++),a[m][0][1]&&(l[2]+=a[m][0][1][0][i]*vm.selected[m].v,s[2]++),a[m][1]&&(l[3]+=a[m][1][0][0][i]*vm.selected[m].v,s[3]++)}0!=s[1]&&(l[1]=l[1]/s[1]),l[2]=0==s[2]?2*l[1]:l[2]/s[2],l[3]=0==s[3]?l[2]+l[1]:l[3]/s[3];for(var h=[[],[],[],[],[]],c=0;5>c;c++)if(vm.selectedArmor[c])h[c].push(vm.selectedArmor[c]);else{var g=!0;for(var w in armor[e][c]){for(var k=armor[e][c][w].h,A=0,m=0;n>m;m++){var i=vm.selected[m].n;i in armor[e][c][w].s&&(A+=vm.selected[m].v*armor[e][c][w].s[i])}(A>0||g&&3==k)&&(armor[e][c][w].val=A+l[armor[e][c][w].h],h[c].push(armor[e][c][w]),g=g&&3!=k)}h[c].sort(function(e,r){return r.val-e.val})}for(var S=shortVal(initSkill()),y=15,b=[],M={},I=[],j=[Math.min(h[0].length,3),Math.min(h[1].length,3),Math.min(h[2].length,3),Math.min(h[3].length,3),Math.min(h[4].length,3)],x=0;x<j[0];x++){o[0]=shortMap(h[0][x].s,initSkill()),r[0]=[0,0,0,0].map(holeMap(h[0][x].h));for(var E=0;E<j[1];E++){o[1]=shortMap(h[1][E].s,o[0]),r[1]=r[0].map(holeMap(h[1][E].h));for(var O=0;O<j[2];O++){o[2]=shortMap(h[2][O].s,o[1]),r[2]=r[1].map(holeMap(h[2][O].h));for(var _=0;_<j[3];_++){o[3]=shortMap(h[3][_].s,o[2]),r[3]=r[2].map(holeMap(h[3][_].h));for(var N=0;N<j[4];N++){o[4]=shortMap(h[4][N].s,o[3]),r[4]=r[3].map(holeMap(h[4][N].h));for(var q=initSkill("[]"),J=shortVal(o[4]),u=0,$=new Array(u=r[4][3]+1),z=new Array(u),m=0;n>m;m++)for(var i=vm.selected[m].n,f=(t[i].length,r[4][3]);f>=0;f--){u=r[4][2]+r[4][3]-f+1,$[f]||($[f]=new Array(u),z[f]=new Array(u));for(var p=u-1;p>=0;p--){u=r[4][1]+3*(r[4][3]-f)+2*(r[4][2]-p)+1,$[f][p]||($[f][p]=new Array(u),z[f][p]=new Array(u));for(var d=u-1;d>=0;d--){for(var R=0==m?J:$[f][p][d],T=0==m?o[4]:z[f][p][d],C=f;C>=0;C--)for(var P=p;P>=0;P--)for(var V=d;V>=0;V--)if(a[m][C]&&a[m][C][P]&&a[m][C][P][V]){var D=shortMap(a[m][C][P][V],0==m?o[4]:z[f-C][p-P][d-V]),U=shortVal(D),L=15;R>U&&(R=U,T=D,q[i].push({hole:[0,d,p,f],use:[0,V,P,C]}),(S>U||U==S&&(L=r[4].reduce(holes))<y)&&(y=L,S=U,b=[x,E,O,_,N],I=[m,d,p,f],M=q))}$[f][p][d]=R,z[f][p][d]=T}}}}}}}}var B=new Array(5);B[0]="ranged="+e,B[1]="skill="+vm.selected.map(function(e,r,o){return encodeURIComponent(e.n)}).join("~");var F=initSkill("0");B[2]="armor="+h.map(function(r,o,n){var a=r[b[o]];for(var t in a.s)t in F?F[t]+=a.s[t]:"$"!=t[0]&&(F[t]=a.s[t]);return avalon.isPlainObject(a)?armor[e][o].indexOf(a):vm.selectedArmorIndex[o]}).join("~");var G=[];do{for(var i=vm.selected[I[0]].n,H=M[i],K=null,c=0,k=H[0];c<H.length;k=H[++c])k.hole[1]==I[1]&&k.hole[2]==I[2]&&k.hole[3]==I[3]&&(K=k);if(K){var Q=K.use;I=[I[0]-1,I[1]-Q[1],I[2]-Q[2],I[3]-Q[3]];for(var c=0;c<t[i].length;c++){var W=t[i][c];if(Q[W.h]>0){for(var m in W.s)m in F?F[m]+=W.s[m]*Q[W.h]:"$"!=m[0]&&(F[m]=W.s[m]*Q[W.h]);G.push(gem.indexOf(W)+"*"+Q[W.h])}}}else I=[I[0]-1,I[1],I[2],I[3]]}while(I[0]>=0&&(0!=I[1]||0!=I[2]||0!=I[3]));B[3]="gem="+G.join("~"),B[4]="own="+Object.keys(F).map(function(e,r,o){return encodeURIComponent(e)+"*"+F[e]}).join("~");for(var X=0,m=0;n>m;m++){var i=vm.selected[m].n;vm.selected[m].r>F[i]&&(X++,vm.selected[m].s&&vm.stone.push(vm.selected[m].s))}X>(vm.hasStone?0:Math.min(2,vm.stone.size()))?vm.result="无法配出":vm.result=vm.hasStone?"使用已有护石可以配出":resultMessage[vm.stone.size()],location.hash="#!/result?"+B.join("&"),vm.popup=""},100)},reload:function(){vm.popup="before_loading",vm.closable=!0},load:function(){}});vm.$watch("condition",function(e,r){vm.skill=skill.filter(enable)}),vm.$watch("popup",function(e,r){""!=e&&(document.documentElement.scrollTop=0,document.body.scrollTop=0)}),require(["domReady!","mmRequest","mmRouter"],function(){if(vm.last=localStorage.getItem("update"),vm.last)if(vm.last=new Date(vm.last),vm.last.getTime()>1459500579761){vm.popup="loading",vm.closable=!1,vm.info="读取本地缓存…";var e=new Promise(function(e,r){armor=JSON.parse(localStorage.getItem("armor")),skill=JSON.parse(localStorage.getItem("skill")),gem=JSON.parse(localStorage.getItem("gem")),e("读取本地缓存…")});e.then(function(){vm.popup=""})}else vm.popup="before_loading",vm.closable=!1;else vm.popup="before_loading",vm.closable=!1;vm.load=function(e){var r=[4,0,2,1,3];vm.popup="loading",vm.closable=!1,vm.info="数据读取中…",avalon.getScript("http://c.gamer.qq.com/mho/rsync_cdn_filename_all.js").done(function(){armor=[[[],[],[],[],[]],[[],[],[],[],[]]],skill=[],gem=[],vm.selected=[];for(var o in equipcb){var n=equipcb[o],a=n.iID,t=n.data;if(a>=6e4&&7e4>a&&t[12]>=40){for(var l=t[3],s=r[a%5],m=[],i=21;37>i;i+=3)""!=t[i]&&m.push(t[i]+"x"+t[i+1]);for(var v={},i=38;47>i;i+=2)"#N/A"!=t[i]&&(v[t[i]]=parseInt(t[i+1],10));n={n:t[1],h:t[5],m:m.join("，"),s:v,o:!1},armor[l][s].push(n)}else if(a>=1e6&&2e6>a)skillEffect[t[3]]=95;else if(a>=2e6&&3e6>a)stone[t[2]]=t.slice(2),skillEffect[t[2]]=0!=t[7]?parseInt(100/t[7],10):parseInt(100/t[6],10);else if(a>=5e6&&6e6>a){var m=[t[13]+"x"+t[14],t[15]+"x"+t[16]];""!=t[17]&&m.push(t[17]+"x"+t[18]);var v={};v[t[5]]=parseInt(t[6],10),""!=t[8]&&(v[t[8]]=parseInt(t[9],10)),n={n:t[2],h:t[3],m:m.join("，"),s:v,o:!1},gem.push(n)}}Object.keys(skillEffect).forEach(function(e){skill.push({n:e,v:skillEffect[e],s:stone[e]})}),localStorage.setItem("armor",JSON.stringify(armor)),localStorage.setItem("skill",JSON.stringify(skill)),localStorage.setItem("gem",JSON.stringify(gem)),vm.last=new Date,localStorage.setItem("update",vm.last),vm.popup="",e&&e()}).fail(function(){vm.info="数据读取失败…请稍后再试"})},avalon.router.get("/param",function(){vm.view="param"}),avalon.router.get("/result",function(){var e=this.query;vm.last?result_view(e):vm.load(function(){result_view(e)})}),avalon.history.start({})});
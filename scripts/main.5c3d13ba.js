function initSkill(val){for(var result={},s=0;s<vm.selected.size();s++)result[vm.selected[s].n]=val?eval(val):vm.selected[s].r;return result}function enable(e){var r=!0;return vm.selected.forEach(function(o){e.n==o.n&&(r=!1)}),""!=vm.condition&&e.n.indexOf(vm.condition)<0&&(r=!1),r}function holeMap(e){return function(r,o){return o==e?r+1:r}}function shortMap(e,r){for(var o={},n=0;n<vm.selected.size();n++){var t=vm.selected[n].n;o[t]=t in e?r[t]-e[t]:r[t]}return o}function hasMap(e,r){for(var o={},n=0;n<e.length;n++)for(var t in e[n])t in o?o[t]+=e[n][t]*r[n]:"$"!=t[0]&&(o[t]=e[n][t]*r[n]);return o}function shortVal(e){for(var r=0,o=0;o<vm.selected.size();o++){var n=vm.selected[o].n,t=vm.selected[o].s?Math.max(vm.selected[o].s[4],vm.selected[o].s[5]):0;r+=e[n]<=0?0:1e3+e[n]*vm.selected[o].v+(e[n]>t?1e4:0)}return r}function holes(e,r,o,n){return e*!!(o-1)+r*o}avalon.config({baseUrl:"lib",debug:!1});var armor=[[[],[],[],[],[]],[[],[],[],[],[]]],gem=[],skillEffect={},skill=[],stone={},resultMessage=["无需护石即可配出","至少需要单属性护石可配出","至少需要双属性护石可配出"],vm=avalon.define({$id:"mho",last:0,popup:"",closable:!0,skill:[],selected:[],armor:[],gem:[],stone:[],own:[],info:"",condition:"",hasStone:!1,result:"",$computed:{ranged:{set:function(e){localStorage.setItem("ranged",e)},get:function(){return localStorage.getItem("ranged")?eval(localStorage.getItem("ranged")):!1}}},hidePopup:function(e){vm.closable&&"div"==e.target.nodeName.toLowerCase()&&(vm.popup="")},listSkill:function(){vm.skill=skill.filter(enable),vm.closable=!0,vm.popup="skill_choose"},addSkill:function(e,r){vm.selected.push({n:e.n,v:e.v,r:10,s:e.s}),vm.condition="",vm.popup=""},skillMinus:function(e){e.r--,vm.result=""},skillPlus:function(e){e.r++,vm.result=""},skillJoin:function(e){var r=[];for(var o in e)r.push(o+e[o]);return r.join("，")},showChosen:function(e){e.o=!e.o},secondary:!1,showSecondary:function(){vm.secondary=!vm.secondary},calc:function(){vm.popup="loading",vm.closable=!1,vm.info="计算中，请稍候…",setTimeout(function(){var e=vm.ranged?1:0;vm.stone=[],vm.armor=[],vm.gem=[],vm.own=[];for(var r=[[],[],[],[],[]],o=[{},{},{},{},{}],n=vm.selected.size(),t=new Array(n),a=initSkill("[]"),l=[0,0,0,0],s=[0,0,0,0],v=0;n>v;v++){var i=vm.selected[v].n,m=new Array(4);for(var c in gem)i in gem[c].s&&gem[c].s[i]>0&&(a[i].push(gem[c]),m[gem[c].h]=gem[c].s);var f=0;t[v]=new Array(f=m[3]?6:1);for(var u=f-1?5:0;u>=0;u--){t[v][u]=new Array(f=m[2]?6-u:1);for(var p=f-1;p>=0;p--){t[v][u][p]=new Array(f=m[1]?16-3*u-2*p:1);for(var h=f-1;h>=0;h--)t[v][u][p][h]=hasMap(m,[0,h,p,u])}}t[v][0][0][1]&&(l[1]+=t[v][0][0][1][i]*vm.selected[v].v,s[1]++),t[v][0][1]&&(l[2]+=t[v][0][1][0][i]*vm.selected[v].v,s[2]++),t[v][1]&&(l[3]+=t[v][1][0][0][i]*vm.selected[v].v,s[3]++)}0!=s[1]&&(l[1]=l[1]/s[1]),l[2]=0==s[2]?2*l[1]:l[2]/s[2],l[3]=0==s[3]?l[2]+l[1]:l[3]/s[3];for(var d=[[],[],[],[],[]],c=0;5>c;c++){var g=!0;for(var k in armor[e][c]){for(var S=armor[e][c][k].h,w=0,v=0;n>v;v++){var i=vm.selected[v].n;i in armor[e][c][k].s&&(w+=vm.selected[v].v*armor[e][c][k].s[i])}(w>0||g&&3==S)&&(armor[e][c][k].val=w+l[armor[e][c][k].h],d[c].push(armor[e][c][k]),g=g&&3!=S)}d[c].sort(function(e,r){return r.val-e.val})}for(var M=shortVal(initSkill()),b=15,y=[],I={},A=[],E=[Math.min(d[0].length,3),Math.min(d[1].length,3),Math.min(d[2].length,3),Math.min(d[3].length,3),Math.min(d[4].length,3)],O=0;O<E[0];O++){o[0]=shortMap(d[0][O].s,initSkill()),r[0]=[0,0,0,0].map(holeMap(d[0][O].h));for(var z=0;z<E[1];z++){o[1]=shortMap(d[1][z].s,o[0]),r[1]=r[0].map(holeMap(d[1][z].h));for(var N=0;N<E[2];N++){o[2]=shortMap(d[2][N].s,o[1]),r[2]=r[1].map(holeMap(d[2][N].h));for(var $=0;$<E[3];$++){o[3]=shortMap(d[3][$].s,o[2]),r[3]=r[2].map(holeMap(d[3][$].h));for(var J=0;J<E[4];J++){o[4]=shortMap(d[4][J].s,o[3]),r[4]=r[3].map(holeMap(d[4][J].h));for(var _=initSkill("[]"),j=shortVal(o[4]),f=0,q=new Array(f=r[4][3]+1),x=new Array(f),v=0;n>v;v++)for(var i=vm.selected[v].n,u=(a[i].length,r[4][3]);u>=0;u--){f=r[4][2]+r[4][3]-u+1,q[u]||(q[u]=new Array(f),x[u]=new Array(f));for(var p=f-1;p>=0;p--){f=r[4][1]+3*(r[4][3]-u)+2*(r[4][2]-p)+1,q[u][p]||(q[u][p]=new Array(f),x[u][p]=new Array(f));for(var h=f-1;h>=0;h--){for(var T=0==v?j:q[u][p][h],V=0==v?o[4]:x[u][p][h],D=u;D>=0;D--)for(var P=p;P>=0;P--)for(var C=h;C>=0;C--)if(t[v][D]&&t[v][D][P]&&t[v][D][P][C]){var R=shortMap(t[v][D][P][C],0==v?o[4]:x[u-D][p-P][h-C]),L=shortVal(R),U=15;T>L&&(T=L,V=R,_[i].push({hole:[0,h,p,u],use:[0,C,P,D]}),(M>L||L==M&&(U=r[4].reduce(holes))<b)&&(b=U,M=L,y=[O,z,N,$,J],A=[v,h,p,u],I=_))}q[u][p][h]=T,x[u][p][h]=V}}}}}}}}for(var B=initSkill("0"),c=0;5>c;c++){var F=d[c][y[c]];for(var v in F.s)v in B?B[v]+=F.s[v]:"$"!=v[0]&&(B[v]=F.s[v]);vm.armor.push(F)}do{for(var i=vm.selected[A[0]].n,G=I[i],H=null,c=0,S=G[0];c<G.length;S=G[++c])S.hole[1]==A[1]&&S.hole[2]==A[2]&&S.hole[3]==A[3]&&(H=S);if(H){var K=H.use;A=[A[0]-1,A[1]-K[1],A[2]-K[2],A[3]-K[3]];for(var c=0;c<a[i].length;c++){var Q=a[i][c];Q.use=K[Q.h];for(var v in Q.s)v in B?B[v]+=Q.s[v]*Q.use:"$"!=v[0]&&(B[v]=Q.s[v]*Q.use);Q.use>0&&vm.gem.push(Q)}}else A=[A[0]-1,A[1],A[2],A[3]]}while(A[0]>=0&&(0!=A[1]||0!=A[2]||0!=A[3]));Object.keys(B).forEach(function(e){vm.own.push({n:e,v:B[e]})}),vm.own.sort(function(e,r){var o=vm.selected.size(),n=o;return vm.selected.forEach(function(t,a){e.n==t.n&&(o=a),r.n==t.n&&(n=a)}),o-n});for(var W=0,v=0;v<vm.selected.size();v++){var i=vm.selected[v].n;vm.selected[v].r>B[i]&&(W++,vm.selected[v].s&&vm.stone.push(vm.selected[v].s))}W>(vm.hasStone?0:Math.min(2,vm.stone.size()))?vm.result="无法配出":vm.result=vm.hasStone?"使用已有护石可以配出":resultMessage[vm.stone.size()],vm.popup=""},100)},reload:function(){vm.popup="before_loading",vm.closable=!0},load:function(){}});vm.$watch("condition",function(e,r){vm.skill=skill.filter(enable)}),vm.$watch("popup",function(e,r){""!=e&&(document.documentElement.scrollTop=0,document.body.scrollTop=0)}),vm.$watch("selected.length",function(e,r){vm.result=""}),require(["domReady!","mmRequest"],function(){if(vm.last=localStorage.getItem("update"),vm.last)if(vm.last=new Date(vm.last),vm.last.getTime()>1456200635506){vm.popup="loading",vm.closable=!1,vm.info="读取本地缓存…";var e=new Promise(function(e,r){armor=JSON.parse(localStorage.getItem("armor")),skill=JSON.parse(localStorage.getItem("skill")),gem=JSON.parse(localStorage.getItem("gem")),e("读取本地缓存…")});e.then(function(){vm.popup=""})}else vm.popup="before_loading",vm.closable=!1;else vm.popup="before_loading",vm.closable=!1;vm.load=function(){vm.popup="loading",vm.closable=!1,vm.info="数据读取中…",avalon.getScript("http://c.gamer.qq.com/mho/rsync_cdn_filename_all.js").done(function(){armor=[[[],[],[],[],[]],[[],[],[],[],[]]],skill=[],gem=[],vm.selected=[];for(var e in equipcb){var r=equipcb[e],o=r.iID,n=r.data;if(o>=6e4&&7e4>o&&n[12]>=40){for(var t=n[3],a=o%5,l=[],s=21;37>s;s+=3)""!=n[s]&&l.push(n[s]+"x"+n[s+1]);for(var v={},s=38;47>s;s+=2)"#N/A"!=n[s]&&(v[n[s]]=parseInt(n[s+1],10));r={n:n[1],h:n[5],m:l.join("，"),s:v,o:!1},armor[t][a].push(r)}else if(o>=1e6&&2e6>o)skillEffect[n[3]]=95;else if(o>=2e6&&3e6>o)stone[n[2]]=n.slice(2),skillEffect[n[2]]=0!=n[7]?parseInt(100/n[7],10):parseInt(100/n[6],10);else if(o>=5e6&&6e6>o){var l=[n[13]+"x"+n[14],n[15]+"x"+n[16]];""!=n[17]&&l.push(n[17]+"x"+n[18]);var v={};v[n[5]]=parseInt(n[6],10),""!=n[8]&&(v[n[8]]=parseInt(n[9],10)),r={n:n[2],h:n[3],m:l.join("，"),s:v,o:!1},gem.push(r)}}Object.keys(skillEffect).forEach(function(e){skill.push({n:e,v:skillEffect[e],s:stone[e]})}),localStorage.setItem("armor",JSON.stringify(armor)),localStorage.setItem("skill",JSON.stringify(skill)),localStorage.setItem("gem",JSON.stringify(gem)),vm.last=new Date,localStorage.setItem("update",vm.last),vm.popup=""}).fail(function(){vm.info="数据读取失败…请稍后再试"})}});